%icra18 main
% 0- $ roscore

% I- copy to a new terminal
    % $ rostopic echo /odom >> odom.txt
    % $ rostopic echo /mobile_base/sensors/imu_data >> imu.txt
    % $ rosbag play <rosbag_name.bag>
    
% II- run the matlab script writeOdomMeas.m
writeOdomMeas()
filePath = '/home/mina/workspace/src/Git/do-slam/Utils/icra18/odometryMeasGraphFile.txt';
modifyOdometryFile(filePath,51)

% III- in a new terminal
    % $ cd catkin_ws/
    % $ catkin_make
    % $ source devel/setup.bash
    % $ rosrun depth_extraction extract_depth_images.py
    
% III- in a different terminal
    % $ roscore 
    % $ rosbag play <rosbag_name.bag>

% IV-
%% GT & Measurements Graph Files
n = 51;
VICONFilePath = '/home/mina/Downloads/icra18/VICON/';
writeVICONGroundtruth(VICONFilePath,'robot.txt')
filePath = '/home/mina/workspace/src/Git/do-slam/Utils/icra18/';
modifyGTFile(strcat(filePath,'cameraGroundtruth.txt'),n)
writeVICONGroundtruth(VICONFilePath,'obj1.txt')
modifyGTFile(strcat(filePath,'obj1Groundtruth.txt'),n)
writeVICONGroundtruth(VICONFilePath,'obj2.txt')
modifyGTFile(strcat(filePath,'obj2Groundtruth.txt'),n)

rgbImagesPath =  '/home/mina/Downloads/icra18/images/rgb/';
depthImagesPath =  '/home/mina/Downloads//icra18/images/depth/';
K_Cam = [526.37013657, 0.00000000  , 313.68782938;
         0.00000000  , 526.37013657, 259.01834898;
         0.00000000  , 0.00000000  , 1.00000000 ];
     
[pointsMeasurements,pointsLabels,pointsTurtlebotID,pointsCameras] = ...
    manualLandmarkExtraction(rgbImagesPath,depthImagesPath, K_Cam);
pointsMeasurements = reshape(pointsMeasurements,[3,size(pointsMeasurements,1)/3])';
save('pointsMeasurements','pointsMeasurements');
save('pointsLabels','pointsLabels');
save('pointsTurtlebotID','pointsTurtlebotID');
save('pointsCameras','pointsCameras');
writeLandmarkMeas(pointsMeasurements,pointsLabels,pointsCameras)

unique3DPoints = extractUnique3DPoints(filePath);
writeGroundtruthGraphFile(filePath,unique3DPoints)
writeMeasurementsGraphFile(filePath)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% V-
config = CameraConfig();
setAppConfig(config); % copy same settings for error Analysis
config.set('std2PointsSE3Motion', [0.1,0.1,0.1]');
% config.set('pointMotionMeasurement','Off')
config.set('groundTruthFileName','icra18GT_GraphFile.graph');
config.set('measurementsFileName','icra18Measurement_GraphFile.graph');

% constantSE3Object1Motion = [0.4534,0.0908,0.0002,0,0,0.12]';
% constantSE3Object2Motion = [0.2833,0.3873,0.0006,0.0002,0.0001,-0.165]';
% constantSE3ObjectMotion = [constantSE3Object1Motion,...
%     constantSE3Object2Motion];
% writeDataAssociationVerticesEdges(config,constantSE3ObjectMotion);

% VI-
groundTruthCell  = graphFileToCell(config,config.groundTruthFileName);
measurementsCell = graphFileToCell(config,config.measurementsFileName);

% VII-
timeStart = tic;
graph0 = Graph();
solver = graph0.process(config,measurementsCell,groundTruthCell);
solverEnd = solver(end);
totalTime = toc(timeStart);
fprintf('\nTotal time solving: %f\n',totalTime)

graph0  = solverEnd.graphs(1);
graphN  = solverEnd.graphs(end);
fprintf('\nChi-squared error: %f\n',solverEnd.systems(end).chiSquaredError)
graphN.saveGraphFile(config,'icra18_results.graph');

% VIII- Error analysis
graphGT = Graph(config,groundTruthCell);
results = errorAnalysis(config,graphGT,graphN);

% IX- Plot
figure
subplot(1,2,1)
spy(solverEnd.systems(end).A)
subplot(1,2,2)
spy(solverEnd.systems(end).H)

h = figure; 
xlabel('x')
ylabel('y')
zlabel('z')
hold on
view([-50,25])
plotGraphFile(config,groundTruthCell,[0 0 1]);
resultsCell = graphFileToCell(config,'icra18_results.graph');
plotGraphFile(config,resultsCell,[1 0 0])